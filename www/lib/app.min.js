angular.module("reaki",["ionic","reaki.partials","reaki.directives","reaki.filters","reaki.services","reaki.controllers"]).run(["$ionicPlatform","$ionicPopup",function(e,t){e.ready(function(){function e(){var e=window.location.hash;("#/tab/home"==e||"#/login"==e||"#/"==e)&&o()}function o(){var e=t.confirm({title:"退出系统",template:"确定要退出系统？",okText:"确定",cancelText:"取消"});e.then(function(e){e&&navigator.app.exitApp()})}window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),document.addEventListener("backbutton",e,!1)})}]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("tutorial",{url:"/",templateUrl:"templates/tutorial.html",controller:"TutorialCtrl"}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl"}).state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.home",{url:"/home",views:{"tab-home":{templateUrl:"templates/tab-home.html",controller:"HomeCtrl"}}}).state("tab.projects",{url:"/project",views:{"tab-project":{templateUrl:"templates/tab-projects.html",controller:"ProjectsCtrl"}}}).state("tab.alerts",{url:"/alert",views:{"tab-alert":{templateUrl:"templates/tab-alerts.html",controller:"AlertsCtrl"}}}),t.otherwise("/")}]),angular.module("reaki.controllers",[]).controller("TutorialCtrl",["$scope","$state","$ionicViewService",function(e,t,o){var a=function(){o.clearHistory(),t.go(localStorage.usercode&&localStorage.password?"tab.home":"login")};"true"===localStorage.didTutorial?a():setTimeout(function(){navigator.splashscreen.hide()},750),e.gotoMain=function(){localStorage.didTutorial=!0,a()},e.slideHasChanged=function(){}}]).controller("LoginCtrl",["$scope","$state","$ionicViewService","UserService",function(e,t,o,a){e.login=function(r){a.login(r).then(function(a){e.result=a.message,o.clearHistory(),t.go("tab.home")}).catch(function(t){e.result=t.message})},localStorage.usercode&&localStorage.password&&e.login({usercode:localStorage.usercode,password:localStorage.password})}]).controller("HomeCtrl",["$scope","$state","$ionicPopup","$ionicNavBarDelegate","StatService","UserService",function(e,t,o,a,r,n){e.doRefresh=function(){r.get().then(function(t){e.data=t,e.$broadcast("scroll.refreshComplete")})},e.quit=function(){var e=o.confirm({title:"退出系统",template:"确定要退出系统？",okText:"确定",cancelText:"取消"});e.then(function(e){e&&navigator.app.exitApp()})},e.login=function(e){var e={usercode:localStorage.usercode,password:localStorage.password};n.login(e).catch(function(){t.logout()})},e.logout=function(){localStorage.clear(),localStorage.didTutorial="true",t.go("login")},e.login(),setInterval(function(){e.login(),e.doRefresh()},3e5),localStorage.statistc?e.data=JSON.parse(localStorage.statistc):e.doRefresh()}]).controller("ProjectsCtrl",["$scope","$ionicActionSheet","$ionicModal","$timeout","ProjectService","DeviceService",function(e,t,o,a,r,n){function i(){n.getLast(e.device.ID).then(function(t){if(!t||"null"==t)return void(e.realdata={Time:"无数据"});tower=e.device,t.SafeLoad<.5&&(t.SafeLoad=3),t.Amplitude>tower.ForeArmLength&&(t.Amplitude=tower.ForeArmLength),t.Height>tower.ArmHeight&&(t.Height=tower.ArmHeight);var o=170+400*t.Amplitude/tower.ForeArmLength,a=450*t.Height/tower.ArmHeight;move("#car").x(o).y(88).end(),move("#rope").x(o).y(100).set("height",a+"px").end(),move("#hook").x(o).y(a+100).end();var r=t.Time.replace("T"," ").substr(0,19);t.Time=r;var n=(new Date).getTime()-new Date(t.Time).getTime()<18e4;t.IsOnline=n?"在线":"离线",t.Amplitude=tower.HasAmplitude?t.Amplitude.toFixed(2)+" 米":"未安装",t.Height=tower.HasHeight?t.Height.toFixed(2)+" 米":"未安装",t.Angle=tower.HasAngle?t.Angle.toFixed(2)+" 度":"未安装",t.Rotation=tower.HasRotation?t.Rotation.toFixed(2)+" 度":"未安装",t.LoadRate=tower.HasWeight?(t.Weight/t.SafeLoad*100).toFixed(2)+" %":"未安装",t.Weight=tower.HasWeight?t.Weight.toFixed(2)+" 吨":"未安装",t.Windspeed=tower.HasWindspeed?t.Windspeed.toFixed(2)+" 米/秒":"未安装",e.realdata=t,n||clearInterval(l)})}e.query="",e.search=function(t){e.query=t,e.doRefresh()},e.clear=function(){e.query="",e.doRefresh()},e.show=function(o){e.device=e.shownGroup.devices.rows[o],e.hideSheet=t.show({buttons:[{text:"实时监控"},{text:"报警信息"},{text:"运行数据"}],titleText:"<span>塔机 "+e.device.Name+"["+e.device.SN+"]</span>",cancelText:"取消",cancel:function(){},buttonClicked:function(t){e.openModal(t)}}),a(function(){e.hideSheet()},2e3)};var l,c=["monitor-modal.html","alert-modal.html","rundata-modal.html"];e.modal=[],c.forEach(function(t,a){o.fromTemplateUrl(t,{scope:e,animation:"slide-in-up"}).then(function(t){e.modal[a]=t})}),e.openModal=function(t){if(e.modal[t].show(),e.hideSheet(),0==t){var o=document.querySelector("#canvas").clientWidth;move("#car").x(170).y(88).end(),move("#rope").x(170).y(100).end(),move("#hook").x(170).y(110).end(),move("#canvas").set("transform-origin","0 0").set("-webkit-transform-origin","0 0").set("-moz-transform-origin","0 0").set("-ms-transform-origin","0 0").scale(o/600,o/600).set("height",o+"px").set("display","block").end(),i(),l=setInterval(i,2e3)}else if(1==t){var a={};a.page=1,a.moreCanBeLoad=function(){return a.data&&20*a.page<a.data.total?!0:!1},a.loadMore=function(){a.page=a.page+1,n.getAlertData(e.device.ID,a.page).then(function(e){a.data.rows=a.data.rows.concat(e.rows),a.data.total=e.total}).finally(function(){e.$broadcast("scroll.infiniteScrollComplete")})},a.doRefresh=function(){a.page=1,n.getAlertData(e.device.ID,a.page).then(function(e){a.data=e}).finally(function(){e.$broadcast("scroll.refreshComplete")})},e.alertdata=a,a.doRefresh()}else if(2==t){var r={};r.page=1,r.moreCanBeLoad=function(){return r.data&&20*r.page<r.data.total?!0:!1},r.loadMore=function(){r.page=r.page+1,n.getRunData(e.device.ID,r.page).then(function(e){r.data.rows=r.data.rows.concat(e.rows),r.data.total=e.total}).finally(function(){e.$broadcast("scroll.infiniteScrollComplete")})},r.doRefresh=function(){r.page=1,n.getRunData(e.device.ID,r.page).then(function(e){r.data=e}).finally(function(){e.$broadcast("scroll.refreshComplete")})},e.rundata=r,r.doRefresh()}},e.closeModal=function(t){e.modal[t].hide(),clearInterval(l),e.realdata=null},e.page=parseInt(localStorage.projectsPage)||1,e.moreCanBeLoad=function(){return e.data&&20*e.page<e.data.total?!0:!1},e.loadMore=function(){e.page=e.page+1,r.all(e.page,e.query).then(function(t){e.data.rows=e.data.rows.concat(t.rows),e.data.total=t.total,localStorage.projects=JSON.stringify(e.data)}).finally(function(){e.$broadcast("scroll.infiniteScrollComplete")})},e.doRefresh=function(){e.page=1,r.all(e.page,e.query).then(function(t){e.data=t}).finally(function(){e.$broadcast("scroll.refreshComplete")})},e.toggleGroup=function(t){e.isGroupShown(t)?e.shownGroup=null:(r.getDevices(t.ProjectID).then(function(t){e.shownGroup.devices=t}),e.shownGroup=t)},e.isGroupShown=function(t){return e.shownGroup===t},localStorage.projects?e.data=JSON.parse(localStorage.projects):e.doRefresh()}]).controller("AlertsCtrl",["$scope","$ionicModal","AlertService","DeviceService",function(e,t,o,a){e.query="",e.search=function(t){e.query=t,e.doRefresh()},e.clear=function(){e.query="",e.doRefresh()},t.fromTemplateUrl("alert-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openModal=function(t){e.device=e.data.rows[t],e.modal.show();var o={};o.page=1,o.moreCanBeLoad=function(){return o.data&&20*o.page<o.data.total?!0:!1},o.loadMore=function(){o.page=o.page+1,a.getAlertData(e.device.TowerCraneID,o.page).then(function(e){o.data.rows=o.data.rows.concat(e.rows),o.data.total=e.total}).finally(function(){e.$broadcast("scroll.infiniteScrollComplete")})},o.doRefresh=function(){o.page=1,a.getAlertData(e.device.TowerCraneID,o.page).then(function(e){o.data=e}).finally(function(){e.$broadcast("scroll.refreshComplete")})},e.alertdata=o,o.doRefresh()},e.closeModal=function(){e.modal.hide()},e.page=parseInt(localStorage.alertsPage)||0,e.moreCanBeLoad=function(){return console.log("moreCanBeLoad"),e.data&&20*e.page<e.data.total?!0:!1},e.loadMore=function(){console.log("loadMore"),e.page=e.page+1,o.all(e.page,e.query).then(function(t){e.data.rows=e.data.rows.concat(t.rows),e.data.total=t.total,localStorage.alerts=JSON.stringify(e.data)}).finally(function(){e.$broadcast("scroll.infiniteScrollComplete")})},e.doRefresh=function(){e.page=1,o.all(e.page,e.query).then(function(t){e.data=t,localStorage.alerts=JSON.stringify(t),localStorage.alertsPage=e.page}).finally(function(){e.$broadcast("scroll.refreshComplete")})},localStorage.alerts?e.data=JSON.parse(localStorage.alerts):e.doRefresh()}]).controller("DeviceCtrl",["$scope",function(){}]),angular.module("reaki.directives",[]),angular.module("reaki.filters",[]),angular.module("reaki.services",[]).factory("UserService",["$q","$http",function(e,t){return{login:function(o){var a=e.defer();return o&&o.usercode&&o.password||a.reject({status:"error",message:"用户名或密码不能为空！"}),t.post("http://rjtms.com/login/doAction",o).success(function(e){"success"==e.status?(localStorage.usercode=o.usercode,localStorage.password=o.password,a.resolve(e)):a.reject(e)}).error(function(e){a.reject(e)}),a.promise}}}]).factory("StatService",["$q","$http",function(e,t){return{get:function(){var o=e.defer();return t.get("http://rjtms.com/api/TowerCrane/Statistic/GetStatisticCount").success(function(e){localStorage.statistc=JSON.stringify(e),o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]).factory("DeviceService",["$q","$http","$filter",function(e,t,o){return{all:function(o){var a=e.defer();return t.get("http://rjtms.com/api/TowerCrane/TowerCrane?rows=10&page="+o).success(function(e){localStorage.devices=JSON.stringify(e),localStorage.devicesPage=o,a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},getLast:function(o){var a=e.defer();return t.get("http://rjtms.com/api/TowerCrane/RealTimeData/GetLast?TowerCraneID="+o).success(function(e){var t="";0==e.AlarmID?e.State="正常":(e.AL_Load&&(t+="吊重报警"),e.AL_Incline&&(t+="倾斜报警"),e.AL_Windspeed&&(t+="风速报警"),e.AL_ObstacleCollision&&(t+="障碍物碰撞预警"),e.AL_TowerCollision&&(t+="塔吊碰撞预警"),e.AL_Limit&&(t+="限位报警"),e.AL_ForbiddenZone&&(t+="禁行区报警"),e.State=t),a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},getRunData:function(a,r){var n=e.defer(),i=o("date")(new Date,"yyyy-MM-dd");return t.get("http://rjtms.com/api/TowerCrane/RealTimeData?TowerCraneID="+a+"&Time="+i+"&rows=10&page="+r).success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},getAlertData:function(a,r){var n=e.defer(),i=o("date")(new Date,"yyyy-MM-dd");return t.get("http://rjtms.com/api/TowerCrane/AlarmData?TowerCraneID="+a+"&Time="+i+"&rows=10&page="+r).success(function(e){e.rows.forEach(function(e){var t="";e.AL_Load&&(t+="吊重报警"),e.AL_Incline&&(t+="倾斜报警"),e.AL_Windspeed&&(t+="风速报警"),e.AL_ObstacleCollision&&(t+="障碍物碰撞预警"),e.AL_TowerCollision&&(t+="塔吊碰撞预警"),e.AL_Limit&&(t+="限位报警"),e.AL_ForbiddenZone&&(t+="禁行区报警"),e.State=t}),n.resolve(e)}).error(function(e){n.reject(e)}),n.promise}}}]).factory("ProjectService",["$q","$http",function(e,t){return{all:function(o,a){var r=e.defer();return t.get("http://rjtms.com/api/TowerCrane/Monitor?ProjectName="+a+"&rows=10&page="+o).success(function(e){localStorage.projects=JSON.stringify(e),localStorage.projectsPage=o,r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},getDevices:function(o){var a=e.defer();return t.get("http://rjtms.com/api/TowerCrane/Monitor/GetDetail/?ProjectID="+o).success(function(e){a.resolve(e)}).error(function(e){a.reject(e)}),a.promise}}}]).factory("AlertService",["$q","$http","$filter",function(e,t,o){return{all:function(a,r){var n=e.defer(),i=o("date")(new Date,"yyyy-MM-dd");return t.get("http://rjtms.com/api/TowerCrane/Report/GetAlarmStatistics?ProjectName="+r+"&Time="+i+"&rows=10&page="+a).success(function(e){localStorage.alerts=JSON.stringify(e),localStorage.alertsPage=a,n.resolve(e)}).error(function(e){n.reject(e)}),n.promise}}}]);